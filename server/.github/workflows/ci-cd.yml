name: StreamX Server CI/CD

on:
    push:
        branches: [main, develop]
        paths:
            - 'server/**'
    pull_request:
        branches: [main, develop]
        paths:
            - 'server/**'
    workflow_dispatch:

jobs:
    test:
        name: Test Server
        runs-on: ubuntu-latest

        defaults:
            run:
                working-directory: ./server

        services:
            redis:
                image: redis:alpine
                ports:
                    - 6379:6379
                options: >-
                    --health-cmd "redis-cli ping"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '20'
                  cache: 'npm'
                  cache-dependency-path: './server/package-lock.json'

            - name: Install dependencies
              run: npm ci

            - name: Create .env file
              run: |
                  touch .env
                  echo "REDIS_URL=redis://localhost:6379" >> .env
                  echo "PORT=3000" >> .env
                  echo "MONGO_DB_URI=${{ secrets.MONGO_DB_URI }}" >> .env
                  echo "AUTH0_AUDIENCE=${{ secrets.AUTH0_AUDIENCE }}" >> .env
                  echo "AUTH0_DOMAIN=${{ secrets.AUTH0_DOMAIN }}" >> .env
                  echo "TOKEN_SECRET=${{ secrets.TOKEN_SECRET }}" >> .env

            - name: Run tests
              run: npm run tests
